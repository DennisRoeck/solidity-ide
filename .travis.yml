sudo: false
language: java
jdk: 
 - oraclejdk8
before_cache:
 - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
 - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
services:
 - docker
cache:
  directories:
  - $HOME/.m2
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
  - $HOME/.cache/yarn
env:
  global:
  - DISPLAY=:99.0
  - MAVEN_OPTS="-Xmx4g"
  - TERM=dumb
  - TARGET=Latest.target
before_install:
- sh -e /etc/init.d/xvfb start - sleep 10
- chmod +x $TRAVIS_BUILD_DIR/extensions/vscode/gradlew
jobs:
  include:
    - stage: Build YAKINDU Solidity IDE and language server
      script: 
      - cd releng/com.yakindu.solidity.releng
      - mvn clean verify -P$TARGET,tests
      - cd ../com.yakindu.solidity.repository/target
      - zip -r repository.zip repository
#    - stage: VSCode extensions
#      script: 
      - cd $TRAVIS_BUILD_DIR/extensions/vscode
      - ./gradlew vscodeExtension
#    - stage: Theia extensions
#      script:
      - cd $TRAVIS_BUILD_DIR/extensions/theia
      - cp -r $TRAVIS_BUILD_DIR/plugins/com.yakindu.solidity.ide/target/languageserver docker/theia_app/xtext-dsl-extension/lsp
      - cp -r $TRAVIS_BUILD_DIR/extensions/theia/ide docker/theia_app/ide
      - cd docker/theia_app
      - yarn install 
      - docker build extensions/theia/docker/theia_app/. -t yakindu/solidity-ide
      deploy:
        skip_cleanup: true
        on:
          all_branches: true
        github_token: $GITHUB_TOKEN
        provider: script
        script: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD && docker push yakindu/solidity-ide
